{% extends "base.html" %}

{% block content %}
<div class="form-container">
    <h2>Settings</h2>
    
    <form method="POST">
        <div class="form-group">
            <label for="theme">Theme:</label>
            <select name="theme" id="theme">
                <option value="dark" {% if settings.theme == 'dark' %}selected{% endif %}>
                    Dark Mode
                </option>
                <option value="light" {% if settings.theme == 'light' %}selected{% endif %}>
                    Light Mode
                </option>
            </select>
        </div>
        
        <div class="form-group">
            <label for="display_mode">Display Mode:</label>
            <select name="display_mode" id="display_mode">
                <option value="missed" {% if settings.display_mode == 'missed' %}selected{% endif %}>
                    Missed Mode - Red for missed scheduled tasks
                </option>
                <option value="schedule" {% if settings.display_mode == 'schedule' %}selected{% endif %}>
                    Schedule Mode - Light green for unscheduled days
                </option>
            </select>
        </div>
        
        <div class="form-group">
            <button type="submit" class="btn">Save Settings</button>
            <a href="{{ url_for('home') }}" class="btn btn-secondary">Cancel</a>
        </div>
    </form>
    
    <div style="margin-top: 30px; padding: 15px; background: var(--bg-tertiary); border-radius: 6px;">
        <h4>Color Configuration:</h4>
        <div class="color-config-section">
            <div class="form-group">
                <label for="missed-sunday-color">Missed Sunday Color:</label>
                <input type="color" id="missed-sunday-color" 
                       value="{{ colors[settings.theme + '_theme'].missed_sunday_color if colors else '#dc2626' }}"
                       onchange="updateColor('missed_sunday_color', this.value)">
                <span class="color-description">Color for missed tasks on Sundays</span>
            </div>
            
            <div class="form-group">
                <label for="missed-regular-color">Missed Regular Day Color:</label>
                <input type="color" id="missed-regular-color" 
                       value="{{ colors[settings.theme + '_theme'].missed_regular_color if colors else '#ffffff' }}"
                       onchange="updateColor('missed_regular_color', this.value)">
                <span class="color-description">Color for missed tasks on other days (set to transparent for no color)</span>
            </div>
            
            <div class="form-group">
                <label for="success-color">Success Color:</label>
                <input type="color" id="success-color" 
                       value="{{ colors[settings.theme + '_theme'].success_color if colors else '#39d353' }}"
                       onchange="updateColor('success_color', this.value)">
                <span class="color-description">Color for completed tasks</span>
            </div>
            
            <div class="form-group">
                <label for="unscheduled-color">Unscheduled Color:</label>
                <input type="color" id="unscheduled-color" 
                       value="{{ colors[settings.theme + '_theme'].unscheduled_color if colors else '#9ac59c' }}"
                       onchange="updateColor('unscheduled_color', this.value)">
                <span class="color-description">Color for unscheduled days</span>
            </div>
            
            <button type="button" class="btn" onclick="resetColors()">Reset to Defaults</button>
        </div>
    </div>
    
    <script>
        function updateColor(colorKey, colorValue) {
            const theme = document.getElementById('theme').value + '_theme';
            
            fetch('/save_colors', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/json',
                },
                body: JSON.stringify({
                    theme: theme,
                    colors: {
                        [colorKey]: colorValue
                    }
                })
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update CSS variables immediately
                    document.documentElement.style.setProperty('--' + colorKey.replace('_', '-'), colorValue);
                } else {
                    alert('Error saving color: ' + data.error);
                }
            })
            .catch(error => {
                console.error('Error:', error);
                alert('Error saving color');
            });
        }
        
        function resetColors() {
            if (confirm('Reset all colors to defaults?')) {
                const theme = document.getElementById('theme').value + '_theme';
                const defaultColors = {
                    'missed_sunday_color': '#dc2626',
                    'missed_regular_color': 'transparent',
                    'success_color': theme === 'dark_theme' ? '#39d353' : '#1a7f37',
                    'unscheduled_color': theme === 'dark_theme' ? '#9ac59c' : '#7fb069'
                };
                
                fetch('/save_colors', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json',
                    },
                    body: JSON.stringify({
                        theme: theme,
                        colors: defaultColors
                    })
                })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        location.reload();
                    } else {
                        alert('Error resetting colors: ' + data.error);
                    }
                })
                .catch(error => {
                    console.error('Error:', error);
                    alert('Error resetting colors');
                });
            }
        }
        
        // Update color inputs when theme changes
        document.getElementById('theme').addEventListener('change', function() {
            // This would ideally reload the color values for the new theme
            // For now, the user needs to save and reload the page
        });
    </script>
    
    <style>
        .color-config-section {
            margin: 15px 0;
        }
        
        .color-config-section .form-group {
            display: flex;
            align-items: center;
            gap: 10px;
            margin-bottom: 15px;
        }
        
        .color-config-section label {
            min-width: 180px;
            font-weight: 500;
        }
        
        .color-config-section input[type="color"] {
            width: 50px;
            height: 30px;
            border: 1px solid var(--border-primary);
            border-radius: 4px;
            cursor: pointer;
        }
        
        .color-description {
            font-size: 12px;
            color: var(--text-secondary);
            margin-left: 10px;
        }
    </style>
    
    <div style="margin-top: 30px; padding: 15px; background: var(--bg-tertiary); border-radius: 6px;">
        <h4>Settings Descriptions:</h4>
        <ul style="margin: 10px 0; padding-left: 20px; color: var(--text-secondary);">
            <li><strong>Theme:</strong> Choose between dark and light appearance modes</li>
            <li><strong>Missed Mode:</strong> Days you were supposed to do a task but didn't are shown in red</li>
            <li><strong>Schedule Mode:</strong> Days you're not scheduled to do a task are shown in light green, scheduled but not done days are empty</li>
            <li><strong>Missed Sunday Color:</strong> Special color for missed tasks specifically on Sundays</li>
            <li><strong>Missed Regular Color:</strong> Color for missed tasks on all other days (use transparent for no highlighting)</li>
        </ul>
    </div>
    </div>
</div>
{% endblock %}
