{% extends "base.html" %}

{% block content %}
<div class="task-header">
    <h2>Daily Tasks - Calendar View</h2>
    <div class="nav-links">
        <a href="{{ url_for('daily_tasks', view_type='list') }}" 
           class="btn btn-small {% if view_type == 'list' %}btn-active{% else %}btn-secondary{% endif %}">
            List View
        </a>
        <a href="{{ url_for('daily_tasks', view_type='calendar') }}" 
           class="btn btn-small {% if view_type == 'calendar' %}btn-active{% else %}btn-secondary{% endif %}">
            Calendar View
        </a>
    </div>
</div>

<div class="task-form-container">
    <h3>Add New Task</h3>
    <div class="task-form">
        <input type="text" id="taskInput" placeholder="What did you accomplish today?" 
               style="flex: 2; background: var(--bg-secondary); border: 1px solid var(--border-primary); color: var(--text-primary); padding: 8px 12px; border-radius: 4px; margin-right: 10px;">
        
        <select id="categorySelect" style="flex: 1; background: var(--bg-secondary); border: 1px solid var(--border-primary); color: var(--text-primary); padding: 8px 12px; border-radius: 4px; margin-right: 10px;">
            <option value="">Select Category</option>
            {% for category in categories %}
            <option value="{{ category }}">{{ category }}</option>
            {% endfor %}
        </select>
        
        <input type="text" id="newCategoryInput" placeholder="Or new category" 
               style="flex: 1; background: var(--bg-secondary); border: 1px solid var(--border-primary); color: var(--text-primary); padding: 8px 12px; border-radius: 4px; margin-right: 10px;">
        
        <select id="journeyClassSelect" style="flex: 1; background: var(--bg-secondary); border: 1px solid var(--border-primary); color: var(--text-primary); padding: 8px 12px; border-radius: 4px; margin-right: 10px;">
            <option value="">Select Journey Class</option>
            {% for journey in journey_classes %}
            <option value="{{ journey }}">{{ journey }}</option>
            {% endfor %}
        </select>
        
        <input type="date" id="taskDate" 
               style="background: var(--bg-secondary); border: 1px solid var(--border-primary); color: var(--text-primary); padding: 8px 12px; border-radius: 4px; margin-right: 10px;">
        
        <button onclick="addTask()" class="btn">Add Task</button>
    </div>
</div>

<div class="calendar-container">
    <h3>{{ month_name }} {{ year }}</h3>
    
    <div class="calendar-grid">
        <div class="calendar-weekdays">
            <div class="weekday">Sun</div>
            <div class="weekday">Mon</div>
            <div class="weekday">Tue</div>
            <div class="weekday">Wed</div>
            <div class="weekday">Thu</div>
            <div class="weekday">Fri</div>
            <div class="weekday">Sat</div>
        </div>
        
        <div class="calendar-days">
            {% for week in calendar_weeks %}
                {% for day in week %}
                    {% if day == 0 %}
                        <div class="calendar-day empty"></div>
                    {% else %}
                        {% set date_key = "{}-{:02d}-{:02d}".format(year, month, day) %}
                        {% set day_tasks = tasks_by_date.get(date_key, []) %}
                        <div class="calendar-day" data-date="{{ date_key }}">
                            <div class="day-number">{{ day }}</div>
                            <div class="day-tasks">
                                {% for task in day_tasks %}
                                    <div class="task-item" title="{{ task.task }}">
                                        <span class="task-text">{{ task.task }}</span>
                                        {% if task.category %}
                                            <span class="task-category">{{ task.category }}</span>
                                        {% endif %}
                                        {% if task.journey_class %}
                                            <span class="journey-indicator" title="Journey: {{ task.journey_class }}">ðŸŸ¢</span>
                                        {% endif %}
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}
                {% endfor %}
            {% endfor %}
        </div>
    </div>
</div>

<style>
.task-header {
    display: flex;
    justify-content: space-between;
    align-items: center;
    margin-bottom: 30px;
}

.task-form-container {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 6px;
    padding: 20px;
    margin-bottom: 30px;
}

.task-form {
    display: flex;
    gap: 10px;
    align-items: center;
    flex-wrap: wrap;
}

.calendar-container {
    background: var(--bg-secondary);
    border: 1px solid var(--border-primary);
    border-radius: 6px;
    padding: 20px;
}

.calendar-grid {
    max-width: 100%;
    margin: 0 auto;
}

.calendar-weekdays {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
    margin-bottom: 5px;
}

.weekday {
    text-align: center;
    font-weight: 600;
    color: var(--text-secondary);
    padding: 8px;
    font-size: 12px;
}

.calendar-days {
    display: grid;
    grid-template-columns: repeat(7, 1fr);
    gap: 2px;
}

.calendar-day {
    min-height: 100px;
    background: var(--bg-tertiary);
    border: 1px solid var(--border-primary);
    border-radius: 4px;
    padding: 5px;
    position: relative;
    overflow: hidden;
}

.calendar-day.empty {
    background: transparent;
    border: none;
}

.day-number {
    font-size: 12px;
    font-weight: 600;
    color: var(--text-primary);
    margin-bottom: 3px;
}

.day-tasks {
    display: flex;
    flex-direction: column;
    gap: 2px;
    max-height: 80px;
    overflow-y: auto;
}

.task-item {
    background: var(--bg-primary);
    border: 1px solid var(--border-primary);
    border-radius: 3px;
    padding: 2px 4px;
    font-size: 10px;
    line-height: 1.2;
    position: relative;
    word-wrap: break-word;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
    max-width: 100%;
}

.task-text {
    color: var(--text-primary);
    font-weight: 500;
}

.task-category {
    color: var(--text-secondary);
    font-size: 9px;
    margin-left: 3px;
    font-style: italic;
}

.journey-indicator {
    position: absolute;
    top: 1px;
    right: 2px;
    font-size: 8px;
    line-height: 1;
}

.task-item:hover {
    background: var(--bg-secondary);
    white-space: normal;
    height: auto;
    z-index: 10;
    max-width: none;
    border-color: var(--accent-primary);
}

/* Scrollbar styling for task list */
.day-tasks::-webkit-scrollbar {
    width: 3px;
}

.day-tasks::-webkit-scrollbar-track {
    background: var(--bg-secondary);
    border-radius: 2px;
}

.day-tasks::-webkit-scrollbar-thumb {
    background: var(--border-primary);
    border-radius: 2px;
}

.day-tasks::-webkit-scrollbar-thumb:hover {
    background: var(--text-secondary);
}

/* Responsive design */
@media (max-width: 768px) {
    .calendar-day {
        min-height: 80px;
    }
    
    .task-item {
        font-size: 9px;
        padding: 1px 2px;
    }
    
    .day-number {
        font-size: 11px;
    }
}
</style>

<script>
function addTask() {
    const taskInput = document.getElementById('taskInput');
    const categorySelect = document.getElementById('categorySelect');
    const newCategoryInput = document.getElementById('newCategoryInput');
    const journeyClassSelect = document.getElementById('journeyClassSelect');
    const taskDate = document.getElementById('taskDate');
    
    const task = taskInput.value.trim();
    const category = newCategoryInput.value.trim() || categorySelect.value;
    const journeyClass = journeyClassSelect.value;
    const date = taskDate.value;
    
    if (!task) {
        alert('Please enter a task');
        return;
    }
    
    fetch('/add_daily_task', {
        method: 'POST',
        headers: {
            'Content-Type': 'application/json',
        },
        body: JSON.stringify({
            task: task,
            category: category,
            journey_class: journeyClass,
            date: date
        })
    })
    .then(response => response.json())
    .then(data => {
        if (data.success) {
            location.reload();
        } else {
            alert('Failed to add task: ' + data.error);
        }
    })
    .catch(error => {
        alert('Error adding task: ' + error);
    });
}

// Set today as default date
document.getElementById('taskDate').value = new Date().toISOString().split('T')[0];

// Allow Enter key to add task
document.getElementById('taskInput').addEventListener('keypress', function(e) {
    if (e.key === 'Enter') {
        addTask();
    }
});

// Click on calendar day to set that date for new tasks
document.querySelectorAll('.calendar-day[data-date]').forEach(day => {
    day.addEventListener('click', function() {
        const date = this.getAttribute('data-date');
        document.getElementById('taskDate').value = date;
        document.getElementById('taskInput').focus();
    });
});
</script>
{% endblock %}
